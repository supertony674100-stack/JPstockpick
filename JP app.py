import streamlit as st
import pandas as pd
import yfinance as yf
import pytz
import time
from datetime import datetime

# ==========================================
# 0. システム設定
# ==========================================
jp_tz = pytz.timezone('Asia/Tokyo')
st.set_page_config(page_title="2026 日本コア資産 統合戦情室", layout="wide")

# ==========================================
# 1. 毎日更新：個別銘柄レビューと理想の買値 (全13銘柄)
# ==========================================
DAILY_DATE = "2026/01/21" 
BEST_5_TICKERS = ["6857.T", "3778.T", "9984.T", "6861.T", "6501.T"]

# 銘柄マスタ：買値と目標価格の設定
CORE_DATABASE = {
    "6857.T": {"名": "アドバンテスト", "買値": [9000, 10000], "目標": 15500, "判断": "強気", "レビュー": "AIテスター需要は2026年も盤石。Nvidia動向に注視。"},
    "3778.T": {"名": "さくらインターネット", "買値": [4200, 4800], "目標": 12000, "判断": "押し目待ち", "レビュー": "政府支援のGPUセンターがフル稼働へ。ボラティリティ大。"},
    "9984.T": {"名": "ソフトバンクG", "買値": [8500, 9500], "目標": 16000, "判断": "継続保有", "レビュー": "ARM株が資産価値を牽引。OpenAI連携による日本支配。"},
    "6861.T": {"名": "キーエンス", "買値": [65000, 68000], "目標": 85000, "判断": "優良", "レビュー": "工場の自動化需要は不変。押し目は長期投資の好機。"},
    "6501.T": {"名": "日立製作所", "買値": [3800, 4100], "目標": 6000, "判断": "DX成長", "レビュー": "Lumada事業が収益の柱。社会インフラDXの覇者。"},
    "8035.T": {"名": "東京エレクトロン", "買値": [22000, 25000], "目標": 38000, "判断": "強気", "レビュー": "次世代半導体製造装置で世界シェア堅持。"},
    "4180.T": {"名": "Appier Group", "買値": [1300, 1500], "目標": 2500, "判断": "打診買い", "レビュー": "AI SaaS収益化フェーズ。1,500円以下は割安。"},
    "3993.T": {"名": "PKSHA Tech", "買値": [3800, 4200], "目標": 6800, "判断": "監視継続", "レビュー": "法人向けAI実装のリーダー。次の決算に注目。"},
    "6723.T": {"名": "ルネサス", "買値": [2200, 2400], "目標": 4200, "判断": "押し目買い", "レビュー": "エッジAIチップで存在感。バリュエーション的に放置中。"},
    "2638.T": {"名": "GX 日本ロボAI", "買値": [2300, 2500], "目標": 3500, "判断": "積立推奨", "レビュー": "日本AI・ロボ全体に分散。初心者から上級者まで。"},
    "6954.T": {"名": "ファナック", "買値": [4000, 4300], "目標": 6200, "判断": "回復期待", "レビュー": "産業用ロボの在庫調整完了間近。2026年に期待。"},
    "4063.T": {"名": "信越化学", "買値": [5800, 6200], "目標": 8800, "判断": "鉄板銘柄", "レビュー": "ウエハシェア世界一。AI社会の土台。"},
    "8058.T": {"名": "三菱商事", "買値": [2800, 3100], "目標": 4500, "判断": "継続保有", "レビュー": "電力・資源・AIインフラを網羅。高配当。"}
}

# ==========================================
# 2. データの取得
# ==========================================
def get_comprehensive_data():
    # 指数データ取得
    indices = {"^N225": "日経平均", "^TPX": "TOPIX", "^MOTH": "グロース250"}
    index_results = []
    for ticker, name in indices.items():
        try:
            obj = yf.Ticker(ticker)
            h = obj.history(period="2d")
            curr = h['Close'].iloc[-1]
            chg = curr - h['Close'].iloc[-2]
            pct = (chg / h['Close'].iloc[-2]) * 100
            index_results.append({"名": name, "値": curr, "変": chg, "率": pct})
        except: pass

    # 個別銘柄データ取得
    stock_rows = []
    for ticker, info in CORE_DATABASE.items():
        try:
            s_obj = yf.Ticker(ticker)
            hist = s_obj.history(period="1d")
            if not hist.empty:
                curr = hist['Close'].iloc[-1]
                upside = ((info["目標"] / curr) - 1) * 100
                
                # エントリー判定ロジック
                if curr <= info["買値"][1]: status = "🔥 理想の買値"
                elif curr <= (info["買値"][1] * 1.1): status = "👀 押し目待ち"
                else: status = "⏳ 高値警戒"
                
                stock_rows.append({
                    "コード": ticker, "銘柄名": info["名"], "現在値": curr,
