import streamlit as st
import pandas as pd
import yfinance as yf
import pytz
import time
from datetime import datetime

# ==========================================
# 0. ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
# ==========================================
jp_tz = pytz.timezone('Asia/Tokyo')
st.set_page_config(page_title="2026 æ—¥æœ¬AIæ ª ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æˆ¦æƒ…å®¤", layout="wide")

# ==========================================
# 1. ãƒ‡ã‚¤ãƒªãƒ¼ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ (ã“ã“ã‚’æ¯æ—¥æ›´æ–°ã—ã¦ãã ã•ã„)
# ==========================================
DAILY_DATE = datetime.now(jp_tz).strftime('%Y/%m/%d')
DAILY_REVIEWS = {
    "6857.T": {"ãƒ¬ãƒ“ãƒ¥ãƒ¼": "Nvidiaã®æ±ºç®—æœŸå¾…ã§å …èª¿ã€‚1ä¸‡ã®å¤§å°ã‚’å›ºã‚ã‚‹å‹•ãã€‚", "åˆ¤æ–­": "ç¶™ç¶šä¿æœ‰"},
    "3778.T": {"ãƒ¬ãƒ“ãƒ¥ãƒ¼": "æ”¿åºœã®è¿½åŠ è£œåŠ©é‡‘å ±é“ã§æ€¥é¨°ã€‚ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã«æ³¨æ„ã€‚", "åˆ¤æ–­": "æŠ¼ã—ç›®è²·ã„"},
    "9984.T": {"ãƒ¬ãƒ“ãƒ¥ãƒ¼": "ARMæ ªã®ä¸Šæ˜‡ãŒå¯„ä¸ã€‚è‡ªç¤¾æ ªè²·ã„ã®æœŸå¾…ã‚‚é«˜ã¾ã‚‹ã€‚", "åˆ¤æ–­": "å¼·æ°—"},
    "4180.T": {"ãƒ¬ãƒ“ãƒ¥ãƒ¼": "ãƒ¬ãƒ³ã‚¸ä¸‹é™ã§æ¨ç§»ã€‚1,300å††ã‚’å‰²ã‚Šè¾¼ã¾ãªã‘ã‚Œã°ãƒãƒ£ãƒ³ã‚¹ã€‚", "åˆ¤æ–­": "æ‰“è¨ºè²·ã„"},
    "3993.T": {"ãƒ¬ãƒ“ãƒ¥ãƒ¼": "æ±ºç®—å¾Œã®èª¿æ•´ä¸€å·¡ã€‚ã“ã“ã‹ã‚‰ã®åè»¢ã‚’ç‹™ã„ãŸã„ã€‚", "åˆ¤æ–­": "ç›£è¦–ç¶™ç¶š"},
    "8035.T": {"ãƒ¬ãƒ“ãƒ¥ãƒ¼": "åŠå°ä½“ã‚»ã‚¯ã‚¿ãƒ¼å…¨ä½“ã«è²·ã„æˆ»ã—ã€‚ç›®æ¨™å€¤ã¾ã§è·é›¢ã‚ã‚Šã€‚", "åˆ¤æ–­": "å¼·æ°—"},
    "6723.T": {"ãƒ¬ãƒ“ãƒ¥ãƒ¼": "å††å®‰ãƒ¡ãƒªãƒƒãƒˆãŒæ„è­˜ã•ã‚Œã‚‹ã€‚ã‚¨ãƒƒã‚¸AIã®å—æ³¨å¢—ãŒéµã€‚", "åˆ¤æ–­": "ä¸­ç«‹"},
    "2638.T": {"ãƒ¬ãƒ“ãƒ¥ãƒ¼": "æŒ‡æ•°é€£å‹•ã§å®‰å®šã€‚å€‹åˆ¥æ ªã®ãƒªã‚¹ã‚¯ã‚’æŠ‘ãˆãŸã„å±¤ã«æœ€é©ã€‚", "åˆ¤æ–­": "ç©ç«‹æ¨å¥¨"}
}

# ==========================================
# 2. éŠ˜æŸ„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
# ==========================================
JP_AI_DATABASE = {
    "6857.T": {"è‚¡å": "ã‚¢ãƒ‰ãƒãƒ³ãƒ†ã‚¹ãƒˆ", "åŒºé–“": [9000, 10000], "ç›®æ¨™": 15500},
    "3778.T": {"è‚¡å": "ã•ãã‚‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ", "åŒºé–“": [4200, 4800], "ç›®æ¨™": 12000},
    "9984.T": {"è‚¡å": "ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯G", "åŒºé–“": [8500, 9500], "ç›®æ¨™": 16000},
    "4180.T": {"è‚¡å": "Appier Group", "åŒºé–“": [1300, 1500], "ç›®æ¨™": 2500},
    "3993.T": {"è‚¡å": "PKSHA Tech", "åŒºé–“": [3800, 4200], "ç›®æ¨™": 6800},
    "8035.T": {"è‚¡å": "æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³", "åŒºé–“": [22000, 25000], "ç›®æ¨™": 38000},
    "6723.T": {"è‚¡å": "ãƒ«ãƒã‚µã‚¹", "åŒºam": [2200, 2400], "ç›®æ¨™": 4200},
    "2638.T": {"è‚¡å": "GX æ—¥æœ¬ãƒ­ãƒœAI", "åŒºé–“": [2300, 2500], "ç›®æ¨™": 3500}
}

# ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ­ã‚¸ãƒƒã‚¯
def get_japan_market_data():
    idx_val, chg, pct = None, 0.0, 0.0
    try:
        n225 = yf.Ticker("^N225")
        hist_idx = n225.history(period="2d")
        if not hist_idx.empty:
            idx_val = hist_idx['Close'].iloc[-1]
            chg = idx_val - hist_idx['Close'].iloc[-2]
            pct = (chg / hist_idx['Close'].iloc[-2]) * 100
    except: pass

    rows = []
    for ticker, info in JP_AI_DATABASE.items():
        try:
            s_obj = yf.Ticker(ticker)
            hist = s_obj.history(period="1d")
            if not hist.empty:
                curr = hist['Close'].iloc[-1]
                review_info = DAILY_REVIEWS.get(ticker, {"ãƒ¬ãƒ“ãƒ¥ãƒ¼": "-", "åˆ¤æ–­": "-"})
                upside = ((info["ç›®æ¨™"] / curr) - 1) * 100
                
                rows.append({
                    "ã‚³ãƒ¼ãƒ‰": ticker, "éŠ˜æŸ„å": info["è‚¡å"], "ç¾åœ¨å€¤": round(curr, 0),
                    "ä»Šæ—¥ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼": review_info["ãƒ¬ãƒ“ãƒ¥ãƒ¼"],
                    "æŠ•è³‡åˆ¤æ–­": review_info["åˆ¤æ–­"],
                    "2026ç›®æ¨™": info["ç›®æ¨™"],
                    "ä¸Šæ˜‡æœŸå¾…": round(upside, 1)
                })
        except: continue
    return idx_val, chg, pct, pd.DataFrame(rows)

# ==========================================
# 3. UI æç”»
# ==========================================
st.title("ğŸ‡¯ğŸ‡µ 2026 æ—¥æœ¬AIæ ªãƒ»æ¯æ—¥æ›´æ–°ãƒ¬ãƒ“ãƒ¥ãƒ¼")

# ã‚µã‚¤ãƒ‰ãƒãƒ¼
with st.sidebar:
    st.header("âš¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–")
    live_mode = st.checkbox("è‡ªå‹•æ›´æ–°ã‚’æœ‰åŠ¹åŒ–", value=False)
    refresh_rate = st.slider("æ›´æ–°é–“éš” (ç§’)", 30, 300, 60)
    st.divider()
    st.info(f"ğŸ“… ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°æ—¥: {DAILY_DATE}")

idx_val, chg, pct, df_main = get_japan_market_data()

# å¸‚å ´æ¦‚æ³è¡¨ç¤º
col_m1, col_m2 = st.columns([3, 1])
with col_m1:
    if idx_val:
        st.metric(f"æ—¥çµŒå¹³å‡æ ªä¾¡ ({datetime.now(jp_tz).strftime('%H:%M')})", f"{idx_val:,.2f} JPY", f"{chg:+.2f} ({pct:+.2f}%)")

# ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¿ãƒ–ã§æ§‹æˆ
tab1, tab2 = st.tabs(["ğŸ“‹ ç›£è¦–ãƒœãƒ¼ãƒ‰", "âœï¸ ãƒ‡ã‚¤ãƒªãƒ¼ãƒ»è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼"])

with tab1:
    if not df_main.empty:
        # ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
        def style_judgment(val):
            color = 'red' if val in ['å¼·æ°—', 'æŠ¼ã—ç›®è²·ã„'] else 'green' if 'è²·ã„' in val else 'gray'
            return f'background-color: {color}; color: white; font-weight: bold; border-radius: 5px; padding: 2px'

        # è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿æ•´å½¢
        st.subheader("ç¾åœ¨ã®å¸‚å ´ãƒã‚¸ã‚·ãƒ§ãƒ³")
        st.dataframe(df_main.style.applymap(style_judgment, subset=['æŠ•è³‡åˆ¤æ–­']), use_container_width=True, hide_index=True)

with tab2:
    st.subheader(f"ğŸ” {DAILY_DATE} éŠ˜æŸ„åˆ¥ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼")
    if not df_main.empty:
        for index, row in df_main.iterrows():
            with st.expander(f"{row['éŠ˜æŸ„å']} ({row['ã‚³ãƒ¼ãƒ‰']}) - åˆ¤æ–­: {row['æŠ•è³‡åˆ¤æ–­']}"):
                c1, c2 = st.columns([1, 3])
                with c1:
                    st.write(f"**ç¾åœ¨å€¤:** {row['ç¾åœ¨å€¤']:,.0f}å††")
                    st.write(f"**ç›®æ¨™:** {row['2026ç›®æ¨™']:,.0f}å††")
                    st.write(f"**æœŸå¾…ä½™åœ°:** {row['ä¸Šæ˜‡æœŸå¾…']}%")
                with c2:
                    st.success(f"**ã€æœ¬æ—¥ã®å°‚é–€å®¶ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€‘**\n\n{row['ä»Šæ—¥ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼']}")

# è‡ªå‹•æ›´æ–°å‡¦ç†
if live_mode:
    time.sleep(refresh_rate)
    st.rerun()
